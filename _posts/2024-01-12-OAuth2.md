---
title: OAuth2
date: 2024-01-12 22:00:00 +0900
categories: [ ğŸŒ¼Spring, Spring Security]
tags: [Spring, Spring Security]
math: true
mermaid: true

---

## **OAuth2ë€?**

íŠ¹ì • ì• í”Œë¦¬ì¼€ì´ì…˜(Client)ì—ì„œ ì‚¬ìš©ìì˜ ì¸ì¦ì„ ì§ì ‘ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì‚¬ìš©ì ì •ë³´ë¥¼ ë³´ìœ í•˜ê³  ìˆëŠ” ì‹ ë¢°í•  ë§Œí•œ 

ì¨ë“œ íŒŒí‹° ì• í”Œë¦¬ì¼€ì´ì…˜(GitHub, Google, Facebook ë“±)ì—ì„œ ì‚¬ìš©ìì˜ ì¸ì¦ì„ ëŒ€ì‹  ì²˜ë¦¬í•´ ì£¼ê³  Resourceì— ëŒ€í•œ ìê²© ì¦ëª…ìš© í† í°ì„ ë°œê¸‰í•œ í›„,

Clientê°€ í•´ë‹¹ í† í°ì„ ì´ìš©í•´ ì¨ë“œ íŒŒí‹° ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê²Œ í•´ì£¼ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.


![image](https://github.com/ararp1006/Algorithm/assets/130068083/ed1f334b-b5ff-4787-90d4-72d29b3943b5)


<hr>-------------------------------


## **ë™ì‘ë°©ì‹**

![image](https://github.com/ararp1006/Algorithm/assets/130068083/f58612df-eed4-4c3b-8046-bc43ad23112d)

1. Resource OwnerëŠ” Client ì—­í• ì„ í•˜ëŠ” ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ê²Œ OAuth2 ì¸ì¦ì„ ìš”ì²­í•©ë‹ˆë‹¤.

   Resource OwnerëŠ” ìì‹ ì˜ ê³„ì • ì •ë³´ë¥¼ ê´€ë¦¬í•˜ê³  ìˆëŠ” ì¨ë“œ íŒŒí‹° ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë¡œê·¸ì¸í•˜ê¸¸ ì›í•˜ëŠ” ê²ƒì´ë©°, 
   
   ì´ ìš”ì²­ì„ Clientì¸ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì „ì†¡í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. **(ë¡œê·¸ì¸í™”ë©´ ì œê³µ X)**

2. ClientëŠ” R Resource Ownerì˜ ê³„ì • ì •ë³´ë¥¼ ê´€ë¦¬í•˜ê³  ìˆëŠ” ì¨ë“œ íŒŒí‹° ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë¡œê·¸ì¸í•  ìˆ˜ ìˆë„ë¡ 

   ì¨ë“œ íŒŒí‹° ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸(Redirect)í•©ë‹ˆë‹¤.

3. ë¡œê·¸ì¸ ì¸ì¦ì„ ì§„í–‰í•˜ê³  ë¡œê·¸ì¸ ì¸ì¦ì— ì„±ê³µí•˜ë©´,

4. Authorization Serverê°€ Resource Ownerì˜ ë¡œê·¸ì¸ ì¸ì¦ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜í–‰ë˜ì—ˆìŒì„ ì¦ëª…í•˜ëŠ” **Access Tokenì„ Clientì—ê²Œ ì „ì†¡**í•©ë‹ˆë‹¤.

5. ClientëŠ” ì´ì œ Resource Ownerì˜ ëŒ€ë¦¬ì¸ ì—­í• ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆìœ¼ë¯€ë¡œ, Resource Serverì—ê²Œ Resource Owner ì†Œìœ ì˜ Resourceë¥¼ ìš”ì²­

6.  Resource ServerëŠ” Clientê°€ ì „ì†¡í•œ Access Tokenì„ ê²€ì¦í•´ì„œ Resource Ownerì˜ Resourceë¥¼ Clientì—ê²Œ ì „ì†¡í•©ë‹ˆë‹¤.


**ì–´ë–¤ Resourceë¥¼ ì†Œìœ í•˜ê³  ìˆëŠ” Resource Ownerë¥¼ ëŒ€ì‹ í•˜ëŠ” Clientê°€ Resource Ownerì˜ ëŒ€ë¦¬ì¸ ì—­í• ì„ ìˆ˜í–‰í•œë‹¤ëŠ” ê²ƒ**

<hr>-------------------------------


## **OAuth2 êµ¬í˜„**

![image](https://github.com/ararp1006/Algorithm/assets/130068083/614b0799-e1ba-4b89-bf2a-edfc98c46fbe)

### **ì˜ì¡´ì„± ì¶”ê°€**

``` java
implementation 'org.springframework.boot:spring-boot-starter-security'     
implementation 'org.springframework.boot:spring-boot-starter-oauth2-client' 

```

### **application.yml í´ë¼ì´ì–¸íŠ¸ ì •ë³´ ì¶”ê°€**

``` java
security:
    oauth2:
      client:
        registration:
          google:
            clientId: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx           
            clientSecret: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  


```

### **Configurationì„ í†µí•´ Beanì„ ë“±ë¡í•´ì„œ OAuth 2ì˜ ì¸ì¦ì„ ì„¤ì •**

``` java
@Configuration
public class SecurityConfiguration {
    @Value("${spring.security.oauth2.client.registration.google.clientId}")  // êµ¬ê¸€ í´ë¼ì´ì–¸íŠ¸ ì•„ì´ë””
    private String clientId;

    @Value("${spring.security.oauth2.client.registration.google.clientSecret}") // êµ¬ê¸€ í´ë¼ì´ì–¸íŠ¸ ë¹„ë°€ë²ˆí˜¸
    private String clientSecret;

    @Bean 
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf().disable()
            .formLogin().disable()
            .httpBasic().disable()
            .authorizeHttpRequests(authorize -> authorize
                    .anyRequest().authenticated()
            )
            .oauth2Login(withDefaults());
        return http.build();
    }

    // // ClientRegistrationRepository ì„ ë¹ˆìœ¼ë¡œ ë“±ë¡
    @Bean
    public ClientRegistrationRepository clientRegistrationRepository() {
        var clientRegistration = clientRegistration();   

        return new InMemoryClientRegistrationRepository(clientRegistration);  
    }

    // 
    private ClientRegistration clientRegistration() {
        // ClientRegistrationì€  OAuth 2 Clientì— ëŒ€í•œ ë“±ë¡ ì •ë³´ë¥¼ í‘œí˜„
        return CommonOAuth2Provider
                .GOOGLE
                .getBuilder("google")
                .clientId(clientId)
                .clientSecret(clientSecret)
                .build();
    }
}

```

### **ì»¨íŠ¸ë¡¤ëŸ¬**

``` java
@Controller
public class HelloHomeController {
    @GetMapping("/hello-oauth2")
    public String home(@RegisteredOAuth2AuthorizedClient("google") OAuth2AuthorizedClient authorizedClient) { // (1)

        OAuth2AccessToken accessToken = authorizedClient.getAccessToken();
        System.out.println("Access Token Value: " + accessToken.getTokenValue());
        System.out.println("Access Token Type: " + accessToken.getTokenType().getValue());
        System.out.println("Access Token Scopes: " + accessToken.getScopes());
        System.out.println("Access Token Issued At: " + accessToken.getIssuedAt());
        System.out.println("Access Token Expires At: " + accessToken.getExpiresAt());

        return "hello-oauth2";
    }
}


```